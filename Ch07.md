# 第七章 用 GraphQL 构建购物车系统



上一章我们用 `Vue3` 和 `Express` 构建了一个假期旅游套餐预订系统，首次从零开始搭建后端站点供前端站点请求相关数据接口。独立的后端站点较之前有更强大的功能，可以实现数据存储、身份验证等功能。在管理员前端，我们还演示了路由守卫 `beforeEnter` 的使用来设置访问权限（详见 `admin-frontend` 站点 `src/plugins/vue-router.js`），在用户登录前检查访问令牌是否存在（暂未使用 `jwt` 的 `verify` 方法）。

本章将演示如何用 GraphQL 构建一个购物车系统，相关主题如下：

- 介绍 `GraphQL` 应用程序接口（API）；
- 用 `Express` 创建 `GraphQL` API；
- 创建管理员前端站点；
- 创建消费者前端站点；

本章随书源码详见：https://github.com/PacktPublishing/-Vue.js-3-By-Example/tree/master/Chapter07，或本地仓库 `demos/Chapter07/` 文件夹，实操代码详见 `diy/ch07/` 文件夹。

---



## 1 GraphQL API 简介

上一章用 `Express` 创建的后端站点，接收的请求数据和响应的结果都是 `JSON` 格式的。这样的站点存在两个问题：

- 请求参数可能是后端接口不希望的 `JSON` 格式；
- 在没有前端参与的情况下测试后端 API 接口比较困难；

上述两个问题都能通过 `GraphQL` API 接口解决。`GraphQL` 是一种能让客户端与服务器通信更加便利的特殊的查询语言，内置了对数据结构的校验。每一个属性（`property`）都对应一种数据类型，或简单或复杂。所谓复杂的数据结构，也无非是一系列具有简单数据类型的属性构成。

测试 `GraphQL` API 接口也可以使用 `GraphiQL`——一个便于发送 `GraphQL` 接口请求的网页。由于每一个请求都对应一个数据类型校验，只要遵循 `GraphQL` 的模式（`schema`）的定义，也可以实现请求接口的自动补全功能。`schema` 模式包含了查询和变更所涉及的所有数据类型的定义。这里的查询，是指利用 `GraphQL` 接口查询数据；而变更（`mutations`）是指以某种方式改变数据的 `GraphQL` 请求。

查询及变更通过一个 `schema` 字符串显式定义。这样，入参和出参的数据类型就都是明确的。

GraphQL 接口请求大多为普通的超文本传输协议（`HTTP`）请求，只是结构比较特殊。所有请求默认访问 `/graphql` 端点，而要发送的查询或变更请求，是通过 `JSON` 中的 `query` 属性传入的，其属性值是一个字符串。相关参数的值则通过 `variable` 参数传入。

这些查询或变更请求，通过代码中指定的名称映射到对应的同名解析函数（`resolver functions`）上，而不是 `Vue Router` 映射的路由处理函数（`route handlers`）上。解析函数按照 `schema` 接收相关参数并执行查询，然后在函数的方法体内对获取到的请求结果做进一步处理。

`Vue3` 环境下可以利用基于 `GraphQL` 接口规范的客户端来简化 `GraphQL` 请求的创建，通过传入一个查询或变更的字符串，以及对应的请求参数来完成接口调用。



### 1.1 初始化购物车系统项目

本章将创建一个购物车系统，由三个子项目构成：

- `admin frontend`：基于 `Vue3` 创建的管理员前端站点（使用 `Vue CLI`）；
- `customer frontend`：基于 `Vue3` 的消费者前端站点（使用 `Vue CLI`）；
- `backend`：基于 `Express` 和 `express-graphql` 库创建的后端站点（使用 `express-generator` 工具）；

`express-graphql` 库是 `GraphQL` 接口规范的 `Express` 实现，用于处理 `GraphQL` 请求，并将数据存入 `SQLite` 数据库。

运行以下命令初始化项目：

```bash
# create folders
$ mkdir shopping-cart
$ cd shopping-cart
$ mkdir admin-frontend, frontend, backend
# init admin-frontend, choosing Default Vue 3 when asked
$ cd admin-frontend; vue create .
# init frontend the same way
$ cd ../frontend; vue create .
# init backend with express-generator, or with admin privilege in case failure occurred
$ npm i -g express-generator
$ cd ../backend; npx express-generator
```

实操时的工具版本为：

- `Vue CLI v5.0.0-rc.2`
- `express-generator@4.16.1`

