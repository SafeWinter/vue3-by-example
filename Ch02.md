# 第二章 构建 `Vue 3` 版渐进式 Web 应用



相关主题：

- 组件及渐进式 Web 应用（`PWA`）基础知识
- 引入基于 `GitHub` 的示例应用
- 创建 `PWA`
- 发布 `PWA`

---



## 1 组件及 `PWA` 基础知识

通过 **嵌套**，多个组件构成一个大型应用

通过 **传参**，多个部分组合在一起

通过 **引入库** 或 **手动创建**，生成组件



组件的构成：

- `template` 模板：
  - `HTML` 元素
    - `props`（父传子）
    - `listeners` 侦听器（子传父，携带数据）
  - 组件（`components`）
    - `props`（父传子）
    - `listeners` 侦听器（子传父，携带数据）
  - 指令（`directives`）
- `script` 脚本
- `style` 样式



`PWA` 主要特性：

- 支持安装到 PC 端（可选）
- 通过浏览器管理已安装应用
- 支持部分原生硬件访问（摄像头、麦克风等）
- 可从应用商店获取
- 像其他 `Web` 应用一样部署服务器
- 能为每个用户提供服务
- 响应式设计
- 快速初始化加载（缓存技术）
- 无需联网（借助 `service workers`）
- 想普通 `APP` 一样的交互与导航
- 利用 `service worker` 更新内容
- 仅支持 `HTTPS` 协议
- 支持推送通知
- 可通过 `URL` 进行关联
- 安装后，可从浏览器 home 主页图标启动 `PWA`



本节示例所需插件：`@vue/cli-plugin-pwa`

---



## 2 引入基于 GitHub 接口的示例应用

本章示例为一个展示 `GitHub` 帐号基础信息的 `PWA` 应用

使用工具 `Vite`（默认按 `Vue 3` 创建应用）：

```bash
# install vue cli globally
$ npm install -g @vue/cli@next
# create app by vue cli
$ cd ~/Desktop
$ vue create vue-example-ch2-github-app
$ cd vue-example-ch2-github-app
$ npm run serve
```

> **勘误1**
>
> 执行命令 `npm vue create ...` 报错，应该为 `vue create ...`

或通过 `YARN`（`Y`et `A`nother `R`esource `N`egotiator）工具安装：

```powershell
> yarn global add @vue/cli@next
> yarn create vue-example-ch2-github-app
yarn create v1.22.10
[1/4] Resolving packages...
error An unexpected error occurred: "https://registry.npmjs.org/create-vue-example-ch2-github-app: Not found".
info If you think this is a bug, please open a bug report with the information provided in "C:\\Users\\ad\\AppData\\Local\\Yarn\\Data\\global\\yarn-error.log".
info Visit https://yarnpkg.com/en/docs/cli/create for documentation about this command.
> yarn serve
```

> **勘误2**
>
> 执行命令 `yarn create vue-example-ch2-github-app` 报错，应该是 `yarn create vue-app vue-example-ch2-github-app`。本章演示使用 `Vite` 方式。

---



## 3 创建 PWA 项目

本例会用到由 `Octokit` 开发的开源 `JavaScript` 客户端来访问 `GitHub REST API`。通过该客户端 `GitHub` 支持通过 `token` 令牌免登陆访问帐号及仓库信息（如用户名、仓库列表、`issue` 列表等等）。

`Vue` 的 `CLI` 命令行工具使用 `SFC` （`S`ingle-`F`ile `C`omponents，即单文件组件）与 `ES6` 模块来：

1. 构建和打包项目
2. 发布 Web 服务
3. 在浏览器运行



命令行初始化项目结束后，注意两个文件：

![project structure](assets/c2-7.png)

- `main.js`：`Vue` 应用的入口文件；

- `registerServiceWorker.js`：通过命令 `vue add pwa` 创建，用于在生产环境注册 `service worker` 的脚本文件（利用缓存技术）



接下来对创建好的默认 `Vue` 项目作如下修改：

1. 删除 `index.css`（无该文件）
2. `index.html` 的 `title` 修改为 `GitHub App`
3. 添加 `service worker`：运行命令 `vue add pwa`
4. 删除 `HelloWorld.vue` 组件及其在 `App.vue` 中的引用
5. （接下来的修改都在 `src` 目录下进行）：
6. 添加 `issue` 组件：路径为 `components/repo/Issues.vue`
7. 添加 `comment` 组件：路径为 `components/repo/issue/Comments.vue`
8. 添加 `token` 组件：用于免登陆访问 `GitHub`，路径为 `components/GitHubTokenForm.vue`
9. 添加 `repo` 组件：路径为 `components/Repos.vue`
10. 添加 `user` 组件：路径为 `components/User.vue`
11. 添加混入脚本：`mixins/octokitMixin.js`

修改完毕的项目结构：

![new project structure](assets/c2-8.png)

接下来，需要逐一对创建的文件填充代码——



### 3.1 创建 GitHub 客户端

第 1 步：`src/mixins/octokitMixin.js` 代码如下：

```js
export const octokitMixin = {
  methods: {
    createOctokitClient() {
      return new window.Octokit({
        auth: localStorage.getItem("github-token"),
      });
    }
  }
}
```

> **勘误3、勘误4**
>
> 原书示例代码第 1 行的 import 语句在打包时报错，应注释掉：
>
> ```js
> import { Octokit } from "https://cdn.skypack.dev/@octokit/rest";
> ```
>
> 注释后，原书第 4 行示例代码的 `Octokit` 不可直接调用；而需要按照随书源码的版本，更正为 `new window.Octokit` 来初始化一个客户端实例。



第 2 步：使用 `script` 标签，引入 `octokit-rest.min.js` 文件：

```html
<script src="<%= BASE_URL %>octokit-rest.min.js"></script>
```

> **勘误5**
>
> 无法按原书所述，找到线上的 `octokit-rest` 的 `JS` 脚本。替代方案，从原书附带源码中直接复制到 `public` 文件夹下（详见 `demos/Chapter02/public/octokit-rest.min.js`）



第 3 步：补充 `issues` 和 `comments` 的内容

1. 复制 `Comments.vue`（详见 `demos/Chapter02/src/components/repo/issue/Comments.vue`）到 `src/components/repo/issue/`；
2. 复制 `Issues.vue`（详见 `demos/Chapter02/src/components/Issues.vue`）到 `src/components/`；

> **勘误6**
>
> 随书源码是书中示例代码不同：
>
> ```vue
> <!-- the method is only in the book -->
> created () {
>     this.getRepoIssues(this.owner, this.repo);
> }
> ```





### 3.2 通过 GitHub token 访问用户数据

第 4 步：复制 `GitHubTokenForm.vue`（详见 `demos/Chapter02/src/components/GitHubTokenForm.vue`）到 `src/components/`

> **勘误7**
>
> 生命周期方法钩子不一致：`PDF` 版用的 `created()`，而源码用的 `beforeMount()`



第 5 步：复制 `Repos.vue` 到 `src/components/Repos.vue`（详见 `demos/Chapter02/src/components/Repos.vue`）

> **勘误8**
>
> 组件名称编译报错：Component name "Repos" should always be multi-word.

实测发现组件名称为 `Repos` 时 `ESlint` 会编译不通过，进而导致后期构建打包被中断：

![multi-word error for repos](assets/c2-1.png)

根据 `ESLint` 的官方文档解释：除了根组件 `App`、以及像 `<transition>`、`<component>` 这样的 `Vue` 内置组件，其余自定义组件的名称必须由多个单词组成，以防与 `HTML` 元素标签冲突（`HTML` 的所有元素均为一个单词命名）。

因此这里有两种解决方案：

- 重新命名组件名称，如 `DemoRepos`；
- 改造 `ESLint` 这一规则，设置白名单放行本例中用到的单一单词组件（`Repos`、`User`）。





第 6 步：复制 `User.vue` 到 `src/components/User.vue`（详见 `demos/Chapter02/src/components/User.vue`）

![multi-word error for user](assets/c2-2.png)

> **勘误9**
>
> 组件名称编译报错：Component name "User" should always be multi-word.
>
> 解决方案同上。
>
> **勘误10**
>
> `<li>plan: {{userData.pla && userData.plan.name}}</li>` 应为 `<li>plan: {{userData.plan && userData.plan.name}}</li>`



受影响组件:

- `App.vue`（引入并引用）
- `Repos.vue`（声明）
- `User.vue`（声明）



第 7 步：复制 `App.vue` 到 `src/App.vue`（详见  `demos/Chapter02/src/App.vue` ）：

```vue
<template>
  <div>
    <h1>Github App</h1>
    <GitHubTokenForm />
    <DemoUser />
    <DemoRepos />
  </div>
</template>

<script>
import GitHubTokenForm from "./components/GitHubTokenForm.vue";
import DemoRepos from "./components/Repos.vue";
import DemoUser from "./components/User.vue";

export default {
  name: "App",
  components: {
    GitHubTokenForm,
    DemoRepos,
    DemoUser,
  },
};
</script>
```



## 4 发布 PWA 服务

第 8 步：构建项目

```bash
$ npm run build
```



第 9 步：全局安装 `browser-sync` 并启动本地服务

```bash
$ npm install -g browser-sync
$ cd dist
$ browser-sync
```



第 10 步：在线生成 `GitHub token` 令牌，并填入浏览器的 **GitHub Token** 文本框内

在线生成 `token`：https://github.com/settings/tokens



第 11 步：注意地址栏右边的下载图标，尝试安装 PWA 应用

![URL bar icon to install APP](assets/c2-3.png)



第 12 步：单击安装 `PWA`，在 `chrome://apps` 页面查看安装情况

![install App](assets/c2-4.png)

访问 `chrome://apps`：

![check apps](assets/c2-5.png)



第 13 步：查看开发者模式下的 `Application` 标签页，单击左边的 `Service Workers`：

![Application >> Service Workers panel](assets/c2-6.png)

---





## 小结

- 创建可重用的组件
- 利用 `props` 实现父组件到子组件的通信
- 校验 props 的类型
- `watchers` 的用法（支持异步方法，而计算属性只能用同步方法）
- 生命周期方法钩子在项目中的应用
- 利用插件 `@vue/cli-plugin-pwa` 完成 `Vue` 应用到 `PWA` 应用的转换

